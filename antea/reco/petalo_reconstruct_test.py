import os
import pytest
import antea.reco.petalo_reconstruct as preco

@pytest.mark.skipif(not os.path.isfile("{}/../anteacpp/libPETALO.so".format(os.environ['ANTEADIR'])), reason="Reconstruction C++ library not found")
def test_read_image():
    """
    Tests the ``read_image`` function of class PetaloReconstructor.
    """
    rec = preco.PetaloReconstructor(libpath="{}../anteacpp/libPETALO.so".format(os.environ['ANTEADIR']))
    rec.img_size_xy = 180.0
    rec.img_size_z = 180.0
    rec.img_nvoxels_xy = 60
    rec.img_nvoxels_z = 60
    rec.prefix = "{}testdata/reconstruction_NEMA_test".format(os.environ['ANTEADIR'])
    img = rec.read_image(4)

    assert(img.shape == (rec.img_nvoxels_xy,rec.img_nvoxels_xy,rec.img_nvoxels_z))

@pytest.mark.skipif(not os.path.isfile("{}/../anteacpp/libPETALO.so".format(os.environ['ANTEADIR'])), reason="Reconstruction C++ library not found")
def test_reconstruct():
    """
    Tests the PetaloReconstructor class and its function reconstruct.
    """

    # Define 100 LORs.
    lor_x1  = [-387.9052834372936, -234.63561782590628, -126.62858292980702, 164.18673081426044, 262.9614757816097, -190.15994679299618, 372.6142144425738, 324.2815421050955, 2.4908705997987024, 318.59510865431565, -198.78237263431248, 368.1902029298038, -194.12501296346244, -135.75310029084417, -30.697869032971585, 369.3564377783764, -96.86551974219205, 316.1939651118271, 400.5319897638048, 139.0205114866444, 20.380075442770483, 184.4607060136686, -394.4399383411815, 387.302051438701, -401.53719427669597, -154.57377664115896, -387.74574910449826, 375.44072841045096, -357.46435366292724, 27.647090165248823, 282.47356508886355, 19.01488557990726, 390.7012509149312, 286.0010747049305, 328.3181892646302, -90.36226833969924, 282.9175980064998, -218.14807834375105, 376.3833348675058, -349.72626255605434, 399.05106067895707, -350.46451422180405, 64.38531790810649, -398.9120588961684, 261.7071627444496, -380.71020294255123, -377.3599691900397, -128.8477460141225, 177.35958675086468, -388.6944750200747, -26.429249422731747, 367.5425058295889, 382.7343701641175, -376.8889911491468, -328.04988293491624, 400.5333917553315, 82.73274016230415, -278.7724224145797, 32.35666386550155, -158.68380136671016, -274.31729739315193, 268.46257892288907, -330.77723630797976, -378.7081365519318, -320.138532502211, 328.57990114335365, -351.8095820926963, 377.67520998817287, 224.579502141819, -382.6977920153886, 341.2919057694822, 32.123755956776776, 85.91216571708303, 317.5513897842648, -165.25388551022067, 388.725119473013, -389.72094108783074, 203.26033292437882, 81.5598636704898, 102.71660374087696, -218.97801386131331, -144.6999008028769, 184.3754137063553, 385.24102872545245, 270.3541514380129, 280.67345156932316, -387.9466289422052, -119.24884056469432, -254.73031900172194, -403.71518344730634, -232.46079074275443, 371.03990225198413, 360.95900381909325, 306.97054160735377, 28.955135926840764, 379.65653072624843, 33.265055107936426, -56.46456788765103, -399.0106288830494, -327.8274951851684]

    lor_y1 = [-9.283806752423713, -306.2200433113849, 364.52609722570594, 362.1207886192368, -289.06743720219225, 350.9700881444288, 102.39598334146153, 232.20474487116093, 396.28176985402695, 247.27635003934822, -342.9855184012856, -119.35474615220966, -338.055650432283, 359.6162016912733, 388.52551912673084, 126.8842860483807, 376.54590187440937, 219.39572492836822, -0.1613899759054899, 364.9903494345466, -406.57249922823934, -349.1752788176746, 58.20817299882209, -52.960916185574206, 1.6631133527930146, -352.7508170966282, -11.436984405913972, -135.15823648534754, 163.82301253469862, -398.9762479829515, 281.47741943590535, 384.3697961071658, 44.84900264925734, -287.30894844972215, -227.16443825286163, 378.66226307205665, -294.5749180815328, 329.46325614037386, -105.95118227056587, -209.67441232888027, 12.765296904013626, -166.21449380342466, -394.1995389033336, 77.54291742192721, -291.4547272658012, 108.2504340433957, -143.6057240612658, -385.4131985151713, -351.9040164336391, 53.913132876506104, 399.29094790476825, 155.2699597963157, 62.452520381047464, -108.55247899107422, -203.46951753792698, -55.040673599290386, 377.46276013534475, 275.59370094399594, 402.5552829240379, -359.363119230861, -274.8886374624222, -296.20128373497676, 207.43170160696167, 120.3333310252898, -212.84675972897773, -218.03902031854975, 192.24820839877933, 95.63809858414182, 324.26334320240676, 60.20360745145863, -191.4251846100793, -387.9300192051186, 378.8131826963014, 226.2708807003169, 369.94830028722896, 117.46433027946911, -12.788767235564112, -344.70864350318885, 392.3796083658226, 380.6252321160994, 339.50804218364476, -358.27230683271546, 343.22428643785724, -24.190025294130617, -296.37419815272483, 267.0204176871155, -1.168113494518789, -372.34655675803606, -297.3300907259205, 10.411775627875743, -311.4896440775714, 110.5869034123903, -144.75921060646942, -258.2794098878552, 397.90540790847325, 93.4256162584959, 395.1713712651714, -391.7279260784771, 9.738725297478167, -224.17763401153735]

    lor_z1 = [-116.88238353737276, 46.42163886690665, -25.52398348304449, 42.163072779586216, 47.481789017192526, -61.59951961268738, 129.42790308709095, -65.29316390142365, 82.49729114708724, -74.87404304304229, 49.943014463397986, -45.21028435546739, 64.51904342914283, 79.03180114094604, 100.11790468705759, -17.45842932915966, -101.60010261287549, 117.4269226783805, 11.17612646782301, -90.3854812832307, 147.91560814433555, 40.64902178978913, 93.4045512163922, -92.58257665639233, 6.127000041422711, -145.60438853519037, 44.755489162212186, -105.34790375064152, 57.998387229829504, -35.657758168727405, -116.16338130893489, 59.02823972831004, -185.4235655559267, -132.40279658631692, 46.720821159503984, -47.44585874041247, 61.84020572957384, 8.200429006093277, -55.40299023706144, 104.32583126674271, -19.70280069216164, -67.24191389301026, -27.98961881695307, -39.90402696662791, 117.74121650437921, -40.45580884496284, -70.2393591071734, -43.722538836531584, -68.5787657500078, 23.670026136038118, -25.66011325398767, 17.710332563856866, -6.036943276592183, -78.38795816992425, 77.72543479063236, 50.59109249002358, 77.84076783764712, 113.78771795049663, -15.726531444905518, 22.633801134066047, -28.600907825933632, 64.06237209490222, 52.01074374225177, -72.46382239959742, 67.07296782986225, 144.40951197185254, 50.74413291646133, 145.67281648630484, -154.1293397149674, -38.01301845856792, -60.033189304910096, -80.07736137830928, 10.195923229625812, 107.43068839934945, -76.47309805978682, -96.05178465606429, 44.57739977084968, 62.771597068349195, -93.83333713017308, -67.86901899576586, -37.41332535853402, 122.59209601396111, -22.029550235431614, -40.33164189558827, 3.538861534172785, -15.931949050064272, 73.84256840008962, -23.49051091431391, 64.86716967135439, -70.84130955570909, -45.450839651387355, -135.15379040435045, 26.804660654190535, 108.78226777246145, 14.98012583119187, 115.17739609445754, 28.552379873986457, -16.65120442638694, -28.191507296891512, -35.080100389331335]

    lor_t1 = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]

    lor_x2  = [375.5124510778587, 331.2221956971143, 230.09548612726223, -238.45584624780264, -338.64078632436303, 188.05106163890187, -394.5856956685078, -366.9930493196905, -81.50699468531488, -370.1823426641514, 262.8797936043393, -397.19022453029623, 125.2079166722113, 135.0930497027968, 86.23070237703845, -330.140792293077, 174.46338081633792, -370.46929881141057, -383.7240573474422, -74.97913170245525, -33.8293197032908, -63.03046196729043, 386.59375441764865, -370.4088109733112, 394.09285868045725, 224.87026502705768, 386.2454197584336, -388.6087756117952, 360.47267446196133, 33.877614658017265, -254.5646497915114, 110.65517164766459, -396.28536640871863, -312.35570712857543, -362.7947925609533, 133.35124721000776, -322.77451507420676, 326.4935884192402, -313.33573200002206, 356.5135433615937, -368.5768693901246, 355.96257286457694, 19.94294108383216, 359.33029376183475, -248.52986684182642, 386.9914853006852, 354.39929892342025, 128.49567349304425, -88.80728751346118, 379.97692206716687, 8.610728109360178, -379.82287663877855, -342.9499035732904, 371.9500900889493, 261.43132929589405, -390.2547043466612, -176.09440586089406, 261.66529924338016, -11.959381836087609, 99.64042421196174, 198.57891810479043, -236.39735399122372, 360.88831486477375, 366.07403264802144, 355.1449709783777, -373.4390989436839, 355.4481445370314, -380.5011921929724, -266.5867775265311, 386.60825669946587, -266.81621206875406, 53.91176353659304, -190.45242394053284, -332.95831646290833, 190.41151412462148, -404.4316710611226, 390.2792146279793, -80.98175930993699, 60.991095840853795, -227.06239910019124, 277.5823294547022, 190.8417682593692, -225.21640626459265, -365.94821703812164, -231.23478695805014, -319.0111954870272, 390.54443688117505, 164.43753274068663, 282.8173538682136, 391.313937537415, 337.9200950001714, -350.53169797192896, -274.6664922546441, -273.43778800467686, -41.410046338208055, -401.5385704533668, -166.17455219056265, 89.49497885330696, 390.8693220827187, 312.26310470275666]

    lor_y2 = [95.17123221392767, 222.76144176914482, -329.32425050439014, -311.31501298323144, 195.36814289555318, -352.48092129298067, -58.76664948266788, -162.10544480908126, -376.17250913318986, -116.69245754592826, 304.8754448359681, 51.00434035353557, 387.07562613022725, -376.09188412380917, -385.3037425113333, -222.59105180401588, -346.61304311651134, -148.26261565003819, 101.52201878710657, -376.06248886136524, 402.361758278983, 383.17534655507325, -68.51210384626596, 112.0853728033207, -21.07127595258367, 320.13804693304803, 49.695222752015624, 107.52694487293726, -146.7593043293856, 393.0959486632035, -299.22877824051034, -369.2221127093087, -98.77003239836954, 246.63675621527318, 129.4892144609668, -361.24132182593365, 236.63898096065932, -223.43966954573563, 232.78238881667272, 156.28404812742323, -115.07967254963216, 151.58273370554215, 390.2674878072315, -145.9652700788813, 311.2710470673463, -64.73776837221266, 156.01109288839555, 385.06290931284644, 378.4169201363868, -77.75544324890531, -389.7295832694136, -122.99495616410024, -194.97583417509153, 129.4734338120664, 294.74449772172125, 84.60667987112328, -343.1389138639589, -300.902130113631, -395.92874536769307, 372.667882799852, 334.6868072524921, 315.6386914634952, -184.36444977214612, -135.34396613418625, 175.70226295816963, 104.68341321493786, -164.19312839209132, -89.71756166608662, -284.208079098707, -19.182642708969084, 288.3573904710295, 381.1787226883804, -347.19889715427416, -206.01618623941715, -336.1274900626143, -41.78831860373519, -83.13048387402137, 386.95092973853997, -380.56602706065115, -332.46098014555804, -277.1204456721686, 353.3294531683185, -315.38466550021144, 142.60093824664128, 323.37570787865496, -242.39834940196545, 42.088132259057794, 354.16782918124784, 268.3398044749861, 53.194819559029675, 204.73811091321699, -175.12341873985, 275.1471488722808, 293.25144623158116, -398.31828460851204, -33.028669021047065, -349.32306439765574, 388.57670388793736, 13.976930495839042, 231.4087833658069]

    lor_z2 = [8.919109157908807, 30.674270101731146, 75.6885909516358, -92.79322500072203, -109.97459693101658, -10.077443795591353, -7.979957486954788, 148.104468040111, -56.703619697266525, 88.76698753512672, -12.539297511020706, 139.45577191912446, -169.2378631045342, -110.16647631910229, 32.85051643520319, 27.150476356250863, 11.99232574066523, -90.23020455851014, -126.10452287432166, 120.44327129863217, -109.39737556281267, -24.012530603099023, -79.38644361909721, 141.6859298488866, 87.90094434228196, 105.69633314574001, -59.30381896345595, 17.744379885324093, 78.18081842561598, 149.8569954288567, 96.45436809135954, -107.0654192351054, 44.206427048634794, 62.64510898197477, -62.238088350682716, 77.65446287623068, -111.18970169928, -61.530242731602456, 74.7845427675528, -75.59167809539778, 29.333396310359014, -69.18669507540372, 174.74300069346748, 78.10134237363329, -64.15711785854545, 113.8993012449972, 39.46312379535816, 82.68673855696342, -47.43482077872969, -82.85289671096099, 15.877266955855898, 78.979081690559, 69.9479238923298, 32.90006387029793, -94.01370264027187, -11.677692664003697, -62.62928777371647, -124.90799688257154, -133.75430180485267, 52.88418113137021, 5.396246851593947, 81.01071587237426, -82.7597934707316, -6.940312264228481, -162.6782272896329, -31.999968916467488, -130.93486721864423, -11.276399746037697, 90.90018595241247, 143.46594166829638, 74.4187016022925, 76.39292042211338, 80.81362441086937, -138.22099791927096, 79.02657781472652, -35.930558782023624, -128.56360898869235, 5.708135560661155, 111.51800566044129, 30.400270360554792, 25.040005690482943, -119.09973272668016, 0.7495149490496864, 48.63161870516804, -42.56461038376068, 61.09062118078613, 4.728100100240063, 174.40041202665827, 55.78957400542164, -76.02672131250753, 62.26937787423411, 60.09525024925919, -12.923557650441138, -52.24089785802902, -25.870842537228423, -126.31916840996765, -90.46844434784096, -32.6044332606255, -77.49700022989933, -71.34848154078003]

    lor_t2 = [-0.1585956003989321, 0.2914653935333566, 0.4367093081722796, -0.2304607624334354, -0.1433959493642008, 0.4964492819016327, 0.17001694505336445, 0.24152753092980012, 0.02898153693693814, 0.16522706153468447, 0.4517051520407748, 0.05126527097817378, 0.06845350240376831, 0.37946799867300535, 0.15825756419619702, 0.14929703911631295, 0.018496181665408926, -0.07222473127021072, -0.13707917897996025, 0.1601123616537012, -0.5029367678729514, -0.10454843418821118, -0.23035476871740876, -0.2766435223614011, -0.0036695657858115283, -0.39844768577187856, -0.472732237971926, -0.2220970917113997, -0.03945820741787562, 0.009743993287120436, -0.29768216081095317, -0.10525738312924943, 0.15040932019061967, 0.07117667671914432, 0.26854163053520097, -0.21078302568559368, -0.1900289073240221, -0.1089505353178519, -0.15341349732214896, -0.09255304075277308, -0.35433705319415254, 0.3184272867115499, 0.01538827018821583, 0.01899292700123264, -0.4750474185107949, 0.29109322755823824, -0.23193390750805634, 0.3449706043124625, -0.08438808754227713, -0.4321023675343393, -0.41791700738633875, -0.30791512611856775, 0.09986329285038967, -0.45899250721981183, -0.1147408829426515, -0.16109239049480495, -0.0698819906453095, 0.5837332878181911, 0.2266236157738543, -0.28112783093318644, 0.2562549627872725, 0.1965194464512598, 0.2625999522827306, -0.4464049297743278, -0.19411598428521717, -0.09804237102092506, 0.016616569438746943, -0.11798121127013247, -0.09766893449312325, 0.2752214137291452, 0.333192614945274, 0.1664483461283707, 0.1308610083826498, 0.2776805771150314, 0.216588064230876, -0.15191118619226246, 0.4915387261092142, 0.22896415970071607, -0.26582507884646345, -0.2565844798432981, -0.16168964112875947, -0.3205566923090896, 0.4709778512226287, -0.14492710610671283, -0.4835218244136219, 0.2519118424687012, -0.14095473254578472, 0.31088059396594625, -0.09394419721433053, -0.016859566193722912, 0.23454155570258653, 0.3793738535714101, -0.09294669648614917, -0.3179632771015969, 0.5549066430259879, 0.1842771281726518, 0.1752950925254684, 0.5369750598866447, 0.005564138444993508, 0.019846716912333022]

    # Run the reconstruction.
    rec = preco.PetaloReconstructor(libpath="{}/../anteacpp/libPETALO.so".format(os.environ['ANTEADIR']))
    rec.TOF_resolution = 200
    rec.niterations = 5
    img = rec.reconstruct(lor_x1, lor_y1, lor_z1, lor_t1, lor_x2, lor_y2, lor_z2, lor_t2)

    assert img.shape == (60,60,60)
